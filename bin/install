#!/usr/bin/env php
<?php

function getDirContents($dir, &$results = []) {
	$files = scandir($dir);

	foreach ($files as $key => $value) {
		$path = realpath($dir . DIRECTORY_SEPARATOR . $value);
		if (!is_dir($path)) {
			$results[] = $path;
		}
        elseif ($value != "." && $value != "..") {
			getDirContents($path, $results);
//			$results[] = $path;
		}
	}

	return $results;
}

$projectName      = readline('Enter project name (Eg: My New Plugin): ');
$projectShortName = readline('Enter project short name (Eg: mnp): ');
$rootNamespace    = readline('Enter project root namespace (Eg: MyNewPlugin): ');
$prefixEnv        = readline('Enter prefix for environment key (Eg: MNP_): ');
$prefixDBTable    = readline('Enter prefix for database table (Eg: mnp_): ');
$prefixCache      = readline('Enter prefix for cache key (Eg: mnp-cache): ');
$textDomain       = readline('Enter text domain (Eg: my-new-plugin): ');

if (!$projectName || !$projectShortName || !$rootNamespace || !$prefixEnv || !$prefixDBTable || !$prefixCache || !$textDomain) {
	echo "\n";
	echo '[ERROR] Missing some information. Please try again!';
	echo "\n\n";
	exit();
}

/**
 * Bulk replace prefix for env key.
 */

$filePaths = [
	'/../.env',
	'/../Funcs.php'
];

foreach ($filePaths as $filePath) {
	$realPath   = __DIR__ . $filePath;
	$envContent = file_get_contents($realPath);
	$envContent = preg_replace('/WPSP_/', $prefixEnv, $envContent);
	file_put_contents($realPath, $envContent);
}

/**
 * Bulkd replace namespaces.
 */

$filePaths = [];
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../app'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../config'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../database'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../routes'));
$filePaths = array_merge($filePaths, [__DIR__ . '/../Funcs.php']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../composer.json']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../bootstrap/app.php']);

foreach ($filePaths as $filePath) {
	$funcsContent = file_get_contents($filePath);
	$funcsContent = preg_replace('/WPSP(?!CORE|\s)/', $rootNamespace, $funcsContent);
	file_put_contents($filePath, $funcsContent);
}

/**
 * Other replacements.
 */

// Replace in ".env" file.
$envContent = file_get_contents(__DIR__ . '/../.env');
$envContent = preg_replace('/APP_NAME="(.*?)"/', 'APP_NAME="' . $projectName . '"', $envContent);
$envContent = preg_replace('/APP_SHORT_NAME="(.*?)"/', 'APP_SHORT_NAME="' . $projectShortName . '"', $envContent);
$envContent = preg_replace('/DB_TABLE_PREFIX="(.*?)"/', 'DB_TABLE_PREFIX="' . $prefixDBTable . '"', $envContent);
$envContent = preg_replace('/CACHE_PREFIX="(.*?)"/', 'CACHE_PREFIX="' . $prefixCache . '"', $envContent);
file_put_contents(__DIR__ . '/../.env', $envContent);

// Replace text domain.
$mainContent = file_get_contents(__DIR__ . '/../main.php');
$mainContent = preg_replace('/Plugin Name:(\s*)(.*?)\n/', "Plugin Name:$1" . $projectName . "\n", $mainContent);
$mainContent = preg_replace('/Description:(\s*)(.*?)\n/', "Description:$1" . $projectName . " using WordPress Starter Plugin\n", $mainContent);
$mainContent = preg_replace('/Text Domain:(\s*)(.*?)\n/', "Text Domain:$1" . $textDomain . "\n", $mainContent);
file_put_contents(__DIR__ . '/../main.php', $mainContent);

// Replace language files.
$potContent = file_get_contents(__DIR__ . '/../resources/lang/wpsp.pot');
$potContent = preg_replace('/Project-Id-Version: (.*?)\\n/', 'Project-Id-Version: ' . $projectName . '\n', $potContent);
$potContent = preg_replace('/X-Domain: (.*?)"/', 'X-Domain: '.$textDomain.'"', $potContent);
file_put_contents(__DIR__ . '/../resources/lang/wpsp.pot', $potContent);
rename(__DIR__ . '/../resources/lang/wpsp.pot', $textDomain . '.pot');

$poContent = file_get_contents(__DIR__ . '/../resources/lang/wpsp-vi.po');
$poContent = preg_replace('/Project-Id-Version: (.*?)\\n/', 'Project-Id-Version: ' . $projectName . '\n', $poContent);
$poContent = preg_replace('/X-Domain: (.*?)"/', 'X-Domain: '.$textDomain.'"', $poContent);
file_put_contents(__DIR__ . '/../resources/lang/wpsp-vi.po', $poContent);
rename(__DIR__ . '/../resources/lang/wpsp-vi.po', $textDomain . '-vi.po');

// Messages.
echo 'You are done! Running: "composer update" again and start your work! :)';
echo "\n\n";

// Run "composer update".
exec('composer update');

exit();